#!/bin/bash

ENVIRONMENT=$(echo "$CONTEXT" | jq -r .scope.dimensions.environment)

# Check parameters
HAS_APP_NAME=$(echo "$CONTEXT" | jq -r '.parameters.results[].name' | grep -c "APP_NAME")
HAS_SERVICE_NAME=$(echo "$CONTEXT" | jq -r '.parameters.results[].name' | grep -c "SERVICE_NAME")
HAS_ROLE=$(echo "$CONTEXT" | jq -r '.parameters.results[].name' | grep -c "AWS_ROLE_ARN")

CONFIGMAP_NAME="fluent-bit-config"
CONFIGMAP_NAMESPACE="default"

echo "Checking CloudWatch Logs requirements..."

if [[ "$HAS_APP_NAME" -gt 0 && "$HAS_SERVICE_NAME" -gt 0 && "$HAS_ROLE" -gt 0 && "$ENVIRONMENT" == "prod" && "$CLUSTER_NAME" == "spin-cluster-prod" ]]; then
    echo "Setting app Cloudwatch logs... Looking for config map $CONFIGMAP_NAME in namespace $CONFIGMAP_NAMESPACE"

    # Check ConfigMap existence
    if ! kubectl get configmap "$CONFIGMAP_NAME" -n "$CONFIGMAP_NAMESPACE" > /dev/null 2>&1; then
        echo "Error: Required ConfigMap '$CONFIGMAP_NAME' was not found in namespace '$CONFIGMAP_NAMESPACE'. CloudWatch logs configuration cannot proceed."
        exit 1
    fi
    echo "ConfigMap '$CONFIGMAP_NAME' found."

    for deployment_file in "$OUTPUT_DIR"/deployment-*.yaml; do
        if [ -f "$deployment_file" ]; then
            kind=$(yq eval '.kind' "$deployment_file")
            echo "Processing: $deployment_file of kind $kind"

            if [ "$kind" = "CronJob" ]; then
                    # Add envFrom to fluent-bit container in CronJob
                yq eval -i "(.spec.jobTemplate.spec.template.spec.containers[] | select(.name == \"*fluent-bit*\").envFrom) += [{\"configMapRef\": {\"name\": \"$CONFIGMAP_NAME\"}}]" "$deployment_file"
            else
                # Add envFrom to fluent-bit container in Deployment/others
                yq eval -i "(.spec.template.spec.containers[] | select(.name == \"*fluent-bit*\").envFrom) += [{\"configMapRef\": {\"name\": \"$CONFIGMAP_NAME\"}}]" "$deployment_file"
            fi
            
            echo "Successfully configured cloudwatch logs for $deployment_file"
        fi
    done
else
    echo "Skipping cloudwatch logs configuration for Environment=$ENVIRONMENT, Cluster=$CLUSTER_NAME. Parameters present: APP_NAME=$HAS_APP_NAME, SERVICE_NAME=$HAS_SERVICE_NAME, AWS_ROLE_ARN=$HAS_ROLE"
fi
