#!/bin/bash

APPLICATION_SLUG=$(echo "$CONTEXT" | jq -r .application.slug)
SCOPE_ENVIRONMENT=$(echo "$CONTEXT" | jq -r .scope.dimensions.environment)

IAM=${IAM-"{}"}
IAM_ENABLED=$(echo "$IAM" | jq -r .ENABLED)
IAM_PREFIX=$(echo "$IAM" | jq -r .PREFIX)

if [[ "$IAM_ENABLED" == "false" || "$IAM_ENABLED" == "null" ]]; then
  echo "No IAM role configuration. Skipping role setup"
  return
fi

MAPPING_FILE="$OVERRIDES_PATH/scope/iam/iam_mappings.csv"

# Use awk to find and print the matching value
SOURCE_ROLE=$(awk -F',' -v app="$APPLICATION_SLUG" -v env="rol_${SCOPE_ENVIRONMENT}" '
NR==1 {
    for (i=1; i<=NF; i++) {
        if ($i == env) {
            col_index = i
            break
        }
    }
    if (col_index == 0) exit
    next
}
$1 == app {
    print $col_index
    exit
}
' "$MAPPING_FILE")

if [ -z "$SOURCE_ROLE" ]; then
  echo "âš ï¸ No role mapping found in the mapping file: $MAPPING_FILE"
  echo "   Application: $APPLICATION_SLUG, Environment: $SCOPE_ENVIRONMENT"
  return
fi

# Early validation to ensure role name is not an ARN
if [[ "$SOURCE_ROLE" == arn:aws:iam::* ]]; then
  echo "ðŸš¨ Invalid configuration in mapping file: $MAPPING_FILE"
  echo "   Found ARN instead of role name: $SOURCE_ROLE"
  echo "   Application: $APPLICATION_SLUG, Environment: $SCOPE_ENVIRONMENT"
  echo ""
  echo "   Please update the CSV file to use role names (not ARNs)"
  echo "   Example: 'my-role-name' instead of 'arn:aws:iam::123456789:role/my-role-name'"
  exit 1
fi

echo "âœ… Found application mapping. Cloning role $SOURCE_ROLE"
echo "ðŸš€ Downloading source role $SOURCE_ROLE"

# Verify role exists and get boundary ARN with error handling
if ! ROLE_INFO=$(aws iam get-role --role-name "$SOURCE_ROLE" 2>&1); then
  echo "ðŸš¨ Failed to retrieve role information for: $SOURCE_ROLE"
  echo "   AWS CLI Error: $ROLE_INFO"
  echo "   Please verify:"
  echo "   1. The role name in $MAPPING_FILE is correct (use role name, not ARN)"
  echo "   2. You have permissions to access this role"
  echo "   3. The role exists in the AWS account"
  exit 1
fi

BOUNDARY_ARN="$(echo "$ROLE_INFO" | jq -r '.Role.PermissionsBoundary.PermissionsBoundaryArn // empty')"

echo "ðŸš€ Downloading inline policies"
if ! INLINE_POLICIES=$(aws iam list-role-policies --role-name "$SOURCE_ROLE" --query 'PolicyNames[]' --output text 2>&1 | \
xargs -I {} aws iam get-role-policy --role-name "$SOURCE_ROLE" --policy-name {} --output json 2>&1 | \
  jq -s 'map({TYPE: "inline", VALUE: .PolicyDocument | tostring})' 2>&1); then
  echo "ðŸš¨ Failed to retrieve inline policies for role: $SOURCE_ROLE"
  echo "   Error: $INLINE_POLICIES"
  exit 1
fi

echo "ðŸš€ Downloading managed policies"
if ! ATTACHED_POLICIES=$(aws iam list-attached-role-policies --role-name "$SOURCE_ROLE" --output json 2>&1 | \
 jq '[.AttachedPolicies[] | {"TYPE": "arn", "VALUE": .PolicyArn}]' 2>&1); then
  echo "ðŸš¨ Failed to retrieve attached policies for role: $SOURCE_ROLE"
  echo "   Error: $ATTACHED_POLICIES"
  exit 1
fi

if ! POLICIES=$(jq -n --argjson inline "$INLINE_POLICIES" --argjson attached "$ATTACHED_POLICIES" \
 '$inline + $attached' 2>&1); then
  echo "ðŸš¨ Failed to merge policies"
  echo "   Error: $POLICIES"
  exit 1
fi

if ! IAM="$(
  jq -c -n \
    --arg PREFIX "$IAM_PREFIX" \
    --arg BOUNDARY_ARN "$BOUNDARY_ARN" \
    --argjson POLICIES "$POLICIES" \
    --arg ENABLED "$IAM_ENABLED" '
{
  ENABLED: $ENABLED,
  PREFIX: $PREFIX,
  ROLE: {
    POLICIES: $POLICIES,
    BOUNDARY_ARN: (if $BOUNDARY_ARN=="" then null else $BOUNDARY_ARN end)
  }
}' 2>&1)"; then
  echo "ðŸš¨ Failed to generate IAM configuration"
  echo "   Error: $IAM"
  exit 1
fi

echo "âœ… Generated IAM role configuration based on $SOURCE_ROLE"
echo "$IAM" | jq .

export IAM
