#!/bin/bash

set -euo pipefail

# Get services with scope_id label
SERVICES_JSON=$(kubectl get services -n "$K8S_NAMESPACE" -l "scope_id=$SCOPE_ID" -o json)
NUM_SERVICES=$(echo "$SERVICES_JSON" | jq '.items | length')

if [[ "$NUM_SERVICES" -eq 0 ]]; then
    echo "There is no service for scope_id=$SCOPE_ID. Publishing the rule with an empty backend"

    SCOPE_RULE='{"service": {"name": "response-404", "port": { "number": 80} }}'
elif [[ "$NUM_SERVICES" -eq 1 ]]; then
    echo "Found single service for scope_id=$SCOPE_ID"

    SERVICE_NAME=$(echo "$SERVICES_JSON" | jq -r '.items[0].metadata.name')
    SERVICE_PORT=$(echo "$SERVICES_JSON" | jq -r '.items[0].spec.ports[0].port')

    echo "Service: $SERVICE_NAME, Port: $SERVICE_PORT"

    SCOPE_RULE=$(jq -n \
        --arg name "$SERVICE_NAME" \
        --argjson port "$SERVICE_PORT" \
        '{
            service: {
                name: $name,
                port: {
                    number: $port
                }
            }
        }')
else
    echo "Detected blue/green deployment with $NUM_SERVICES services for scope_id=$SCOPE_ID"

    # Extract blue and green services (assuming first two services)
    BLUE_SERVICE=$(echo "$SERVICES_JSON" | jq -r '.items[0].metadata.name')
    BLUE_PORT=$(echo "$SERVICES_JSON" | jq -r '.items[0].spec.ports[0].port')
    BLUE_WEIGHT=$(echo "$SERVICES_JSON" | jq -r '.items[0].metadata.annotations["weight"] // "100"' | sed 's/"//g')

    GREEN_SERVICE=$(echo "$SERVICES_JSON" | jq -r '.items[1].metadata.name')
    GREEN_PORT=$(echo "$SERVICES_JSON" | jq -r '.items[1].spec.ports[0].port')
    GREEN_WEIGHT=$(echo "$SERVICES_JSON" | jq -r '.items[1].metadata.annotations["weight"] // "0"' | sed 's/"//g')

    echo "Blue: $BLUE_SERVICE (weight: $BLUE_WEIGHT), Green: $GREEN_SERVICE (weight: $GREEN_WEIGHT)"

    # Build blue/green annotation similar to ALB format
    SCOPE_RULE=$(jq -n \
        --arg blue_service "$BLUE_SERVICE" \
        --argjson blue_weight "$BLUE_WEIGHT" \
        --arg green_service "$GREEN_SERVICE" \
        --argjson green_weight "$GREEN_WEIGHT" \
        --argjson port "$BLUE_PORT" \
        '{
            blue_green_annotation: {
                forward: {
                    targetGroups: [
                        {
                            serviceName: $blue_service,
                            weight: $blue_weight
                        },
                        {
                            serviceName: $green_service,
                            weight: $green_weight
                        }
                    ]
                }
            },
            service: {
                name: $blue_service,
                port: {
                    number: $port
                }
            }
        }')
fi

export SCOPE_RULE