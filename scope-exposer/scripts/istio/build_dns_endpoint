#!/bin/bash

set -euo pipefail

echo "=== DEBUG: Starting build_dns_endpoint ==="

SERVICE_DOMAIN=$(echo "$CONTEXT" | jq -r '.parameters.domain // .service.attributes.domain')
echo "DEBUG: SERVICE_DOMAIN=$SERVICE_DOMAIN"

echo "DEBUG: Fetching gateway IP from gateway-public..."
GATEWAY_IP=$(kubectl get gateway -n gateways gateway-public -o jsonpath='{.status.addresses[0].value}')
echo "DEBUG: GATEWAY_IP=$GATEWAY_IP"

if [[ -z "$GATEWAY_IP" || "$GATEWAY_IP" == "null" ]]; then
    echo "ERROR: Could not retrieve gateway IP from gateway-public"
    exit 1
fi

echo "Creating DNSEndpoint for service $SERVICE_NAME with domain $SERVICE_DOMAIN"

DNS_FILE="$OUTPUT_DIR/dnsendpoint-$SERVICE_ID-public.yaml"
CONTEXT_PATH="$OUTPUT_DIR/context-dns-$SERVICE_ID.json"

# Add gateway_ip to context
CONTEXT_WITH_IP=$(echo "$CONTEXT" | jq --arg gateway_ip "$GATEWAY_IP" '. + {gateway_ip: $gateway_ip}')

echo "$CONTEXT_WITH_IP" > "$CONTEXT_PATH"

echo "Building DNSEndpoint Template to $DNS_FILE"

gomplate -c .="$CONTEXT_PATH" \
  --file "$SERVICE_PATH/templates/istio/dns-endpoint.yaml.tpl" \
  --out "$DNS_FILE"

rm "$CONTEXT_PATH"

echo "DEBUG: DNSEndpoint created at $DNS_FILE"
echo "=== DEBUG: build_dns_endpoint completed ==="
